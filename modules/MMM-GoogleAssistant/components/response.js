class AssistantResponse{constructor(t,s){this.config=t,this.callbacks=s,this.showing=!1,this.response=null,this.aliveTimer=null,this.allStatus=["hook","standby","reply","error","think","continue","listen","confirmation"],this.GAStatus={actual:"standby",old:"standby"},this.loopCount=0,this.chime=this.config.chimes,this.resourcesDir="/modules/MMM-GoogleAssistant/resources/",this.imgStatus={hook:this.resourcesDir+this.config.imgStatus.hook,standby:this.resourcesDir+this.config.imgStatus.standby,reply:this.resourcesDir+this.config.imgStatus.reply,error:this.resourcesDir+this.config.imgStatus.error,think:this.resourcesDir+this.config.imgStatus.think,continue:this.resourcesDir+this.config.imgStatus.continue,listen:this.resourcesDir+this.config.imgStatus.listen,confirmation:this.resourcesDir+this.config.imgStatus.confirmation,information:this.resourcesDir+this.config.imgStatus.information,warning:this.resourcesDir+this.config.imgStatus.warning,userError:this.resourcesDir+this.config.imgStatus.userError},this.audioResponse=new Audio,this.audioResponse.autoplay=!0,this.audioResponse.addEventListener("ended",(()=>{logGA("audio end"),this.end()})),this.audioChime=new Audio,this.audioChime.autoplay=!0,this.fullscreenAbove=this.config.useFullscreen}tunnel(t){if("TRANSCRIPTION"==t.type){var s=!1;if(t.payload.done)this.status("confirmation"),document.getElementById("GA-ResultOuput").src="about:blank";t.payload.transcription&&!s&&(this.showTranscription(t.payload.transcription),s=!0)}}playChime(t,s){this.config.useChime&&(this.audioChime.src=this.resourcesDir+(s?t:this.chime[t]))}status(t,s){this.GAStatus.actual=t;var e=document.getElementById("GA-Status");s&&"continue"!=this.GAStatus.old&&this.playChime("beep"),"error"!=t&&"continue"!=t||this.playChime(t),"confirmation"==t&&this.config.confirmationChime&&this.playChime("confirmation"),"WAVEFILE"!=t&&"TEXT"!=t||(this.GAStatus.actual="think"),"MIC"==t&&(this.GAStatus.actual="continue"==this.GAStatus.old?"continue":"listen"),this.GAStatus.actual!=this.GAStatus.old&&(logGA("Status from "+this.GAStatus.old+" to "+this.GAStatus.actual),e.src="hook"==this.GAStatus.old?this.imgStatus.hook:this.imgStatus[this.GAStatus.actual],this.callbacks.GAStatus(this.GAStatus),this.GAStatus.old=this.GAStatus.actual)}prepareGA(){var t=document.createElement("div");t.id="GoogleAssistant",t.style.zoom=this.config.zoom.transcription,t.className="hidden out",t.addEventListener("transitionend",(s=>{"out"==s.path[0].className&&t.classList.add("hidden")}));var s=document.createElement("div");s.id="GA-Result",s.classList.add("hidden");var e=document.createElement("iframe");e.id="GA-ResultOuput",s.appendChild(e),t.appendChild(s);var i=document.createElement("div");i.id="GA-Response",t.appendChild(i);var o=document.createElement("div");o.id="GA-popout",i.appendChild(o);var a=document.createElement("div");a.id="GA-assistant-bar",a.className="GA-popout-asbar",a.tabindex=-1,o.appendChild(a);var n=document.createElement("img");n.id="GA-Status",n.className="GA-assistant_icon",n.src=this.resourcesDir+"standby.gif",n.onclick=t=>{t.stopPropagation(),"reply"==this.GAStatus.actual&&(logGA("Touch Force end"),this.response=null,this.audioResponse.src="",this.playChime("closing"),this.end())},a.appendChild(n);var r=document.createElement("span");r.id="GA-Transcription",r.className="GA-assistant_response",r.textContent="~MMM-GoogleAssistant~",a.appendChild(r);var l=document.createElement("div");l.className="GA-assistant-word-icon",a.appendChild(l);var u=document.createElement("img");u.className="GA-bar_icon",u.src=this.resourcesDir+"assistant_tv_logo.svg",l.appendChild(u),document.body.appendChild(t)}prepareBackground(){var t=document.getElementsByClassName("region fullscreen above")[0].querySelector(".container"),s=t.children,e=document.createElement("div");e.id="module_Fake_GA_DOM",e.classList.add("module","GA_DOM","hidden");var i=document.createElement("header");i.classList.add("module-header"),i.style.display="none",e.appendChild(i);var o=document.createElement("div");o.classList.add("module-content");var a=document.createElement("div");a.id="GA_DOM",o.appendChild(a),e.appendChild(o),t.insertBefore(e,s[s.length])}showError(t){return this.showTranscription(t,"error"),this.status("error"),!0}showTranscription(t){document.getElementById("GA-Transcription").textContent=t}end(t=!0){if(this.showing=!1,this.response){var s=this.response;this.response=null,s&&s.continue?(this.loopCount=0,this.status("continue"),logGA("Continuous Conversation"),this.showTranscription(""),this.callbacks.assistantActivate({type:"MIC",profile:s.lastQuery.profile,key:null,lang:s.lastQuery.lang,isNew:!1,force:!0},Date.now())):(logGA("Conversation ends."),this.status("standby"),this.callbacks.endResponse(),clearTimeout(this.aliveTimer),this.aliveTimer=null,this.aliveTimer=setTimeout((()=>{this.stopResponse((()=>{this.fullscreen(!1,this.GAStatus)}))}),this.config.screenOutputTimer))}else this.status("standby"),this.fullscreen(!1,this.GAStatus),t&&this.callbacks.endResponse()}start(t){if(this.response=t,clearTimeout(this.aliveTimer),this.aliveTimer=null,this.showing&&this.end(),t.error.error)return"TRANSCRIPTION_FAILS"==t.error.error?(logGA("Transcription Failed. Re-try with text"),void this.callbacks.assistantActivate({type:"TEXT",profile:t.lastQuery.profile,key:t.transcription.transcription,lang:t.lastQuery.lang,force:!0,chime:!1,isNew:!1},null)):"TOO_SHORT"==t.error.error&&"continue"==t.lastQuery.status&&this.loopCount<1?(this.status("continue"),this.callbacks.assistantActivate({type:"MIC",profile:t.lastQuery.profile,key:null,lang:t.lastQuery.lang,isNew:!1,force:!0},Date.now()),this.loopCount+=1,void logGA("Loop Continuous Count: "+this.loopCount+"/1")):(this.showError(t.error.message?t.error.message:this.callbacks.translate(t.error.error)),void this.end());var s=t=>{this.showing=!0,this.callbacks.Gateway(t),this.status("reply");this.showScreenOutput(t);this.playAudioOutput(t)?logGA("Wait audio to finish"):(logGA("No response"),this.end())};this.postProcess(t,(()=>{t.continue=!1,this.end()}),(()=>{s(t)}))}stopResponse(t=(()=>{})){this.showing=!1,document.getElementById("GA-Result").classList.add("hidden"),this.audioResponse.src="",document.getElementById("GA-Transcription").textContent="",t()}postProcess(t,s=(()=>{}),e=(()=>{})){this.callbacks.postProcess(t,s,e)}playAudioOutput(t){return!!t.audio&&(this.showing=!0,this.audioResponse.src=this.makeUrl(t.audio.uri),!0)}showScreenOutput(t){return!(this.sercretMode||!t.screen)&&(t.audio||this.showTranscription(this.callbacks.translate("NO_AUDIO_RESPONSE")),this.showing=!0,document.getElementById("GA-ResultOuput").src=this.makeUrl(t.screen.uri),document.getElementById("GA-Result").classList.remove("hidden"),!0)}makeUrl(t){return"/modules/MMM-GoogleAssistant/"+t+"?seed="+Date.now()}fullscreen(t,s,e=!0){var i=document.getElementById("GoogleAssistant"),o=document.getElementById("module_Fake_GA_DOM");t?(i.className="in",this.fullscreenAbove&&e&&(o.classList.remove("hidden"),MM.getModules().enumerate((t=>{t.hide(500,{lockString:"GA_LOCKED"})})))):s&&"standby"==s.actual&&(i.className="out",this.fullscreenAbove&&(o.classList.add("hidden"),MM.getModules().enumerate((t=>{t.show(500,{lockString:"GA_LOCKED"})}))))}forceStatusImg(t){document.getElementById("GA-Status").src=this.imgStatus[t]}}