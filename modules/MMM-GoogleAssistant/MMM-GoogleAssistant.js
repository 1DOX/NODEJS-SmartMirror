logGA=(...s)=>{},Module.register("MMM-GoogleAssistant",{requiresVersion:"2.18.0",defaults:{debug:!1,stopCommand:"stop",assistantConfig:{lang:"en-US",latitude:51.50853,longitude:-.076132,deviceRegistred:!1},responseConfig:{useFullscreen:!1,responseOutputCSS:"response_output.css",screenOutputTimer:5e3,useChime:!0,confirmationChime:!0,chimes:{beep:"beep.mp3",error:"error.mp3",continue:"continue.mp3",confirmation:"confirmation.mp3",open:"Google_beep_open.mp3",close:"Google_beep_close.mp3",opening:"opening.mp3",closing:"closing.mp3",warning:"warning.ogg"},imgStatus:{hook:"hook.gif",standby:"standby.gif",reply:"reply.gif",error:"error.gif",think:"think.gif",continue:"continue.gif",listen:"listen.gif",confirmation:"confirmation.gif",information:"information.gif",warning:"warning.gif",userError:"userError.gif"},zoom:{transcription:"80%",responseOutput:"60%"}},recipes:[]},micConfig:{recorder:"auto",device:"default"},plugins:{onReady:[],onNotificationReceived:[],onActivate:[],onStatus:[]},commands:{},transcriptionHooks:{},responseHooks:{},forceResponse:!1,getScripts:function(){return["/modules/MMM-GoogleAssistant/components/response.js"]},getStyles:function(){return["/modules/MMM-GoogleAssistant/MMM-GoogleAssistant.css","https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"]},getTranslations:function(){return{en:"translations/en.json",fr:"translations/fr.json",it:"translations/it.json",de:"translations/de.json",es:"translations/es.json",nl:"translations/nl.json",pt:"translations/pt.json",ko:"translations/ko.json"}},start:function(){this.aliveTimer=null;const s=["debug","recipes","assistantConfig","responseConfig"];this.helperConfig={},this.helperConfig.micConfig=this.micConfig,this.config.debug&&(logGA=(...s)=>{console.log("[GA]",...s)});for(var t=0;t<s.length;t++)this.helperConfig[s[t]]=this.config[s[t]];this.GAStatus={actual:"standby",old:"standby"},this.assistantResponse=null,this.loadAssistantResponse();var e={transcriptionHooks:{EXT_Stop:{pattern:this.config.stopCommand,command:"EXT_Stop"}},commands:{EXT_Stop:{moduleExec:{module:["MMM-GoogleAssistant"],exec:"__FUNC__(module) => { module.stopCommand() }"},soundExec:{chime:"close"},displayResponse:!1}}};this.parseLoadedRecipe(JSON.stringify(e))},loadAssistantResponse:function(){var s={assistantActivate:s=>{this.assistantActivate(s)},postProcess:(s,t,e)=>{this.postProcess(s,t,e)},endResponse:()=>{this.endResponse()},translate:s=>this.translate(s),GAStatus:s=>{this.doPlugin("onStatus",{status:s}),this.GAStatus=s,this.sendNotification("ASSISTANT_"+this.GAStatus.actual.toUpperCase())},Gateway:s=>this.SendToGateway(s),sendSocketNotification:(s,t)=>{this.sendSocketNotification(s,t)}};this.assistantResponse=new AssistantResponse(this.helperConfig.responseConfig,s)},doPlugin:function(s,t){if(this.plugins.hasOwnProperty(s)){var e=this.plugins[s];if(Array.isArray(e)&&e.length>0)for(var n=0;n<e.length;n++){var i=e[n];this.doCommand(i,t,s)}}},registerPluginsObject:function(s){for(var t in this.plugins)if(s.hasOwnProperty(t)){var e=[];Array.isArray(s[t])?e=e.concat(s[t]):e.push(s[t].toString());for(var n=0;n<e.length;n++)this.registerPlugin(t,e[n])}},registerPlugin:function(s,t){this.plugins.hasOwnProperty(s)&&(Array.isArray(t)&&this.plugins[s].concat(t),this.plugins[s].push(t))},registerCommandsObject:function(s){this.commands=Object.assign({},this.commands,s)},registerTranscriptionHooksObject:function(s){this.transcriptionHooks=Object.assign({},this.transcriptionHooks,s)},registerResponseHooksObject:function(s){this.responseHooks=Object.assign({},this.responseHooks,s)},getDom:function(){var s=document.createElement("div");return s.style.display="none",s},notificationReceived:function(s,t=null,e=null){switch(this.doPlugin("onNotificationReceived",{notification:s,payload:t}),s){case"DOM_OBJECTS_CREATED":this.assistantResponse.prepareGA(),this.assistantResponse.prepareBackground(),this.sendSocketNotification("INIT",this.helperConfig),this.Loading();break;case"GAv4_ACTIVATE":t&&t.type&&t.key?this.assistantActivate(t):this.assistantActivate({type:"MIC"});break;case"GAv4_FORCE_FULLSCREEN":if(this.config.responseConfig.useFullscreen)return logGA("Force Fullscreen: Already activated");this.config.responseConfig.useFullscreen=!0,this.assistantResponse=null,this.loadAssistantResponse(),logGA("Force Fullscreen: AssistantResponse Reloaded");break;case"GAv4_STOP":this.assistantResponse.response&&"reply"==this.GAStatus.actual&&(logGA("Force end"),this.assistantResponse.response=null,this.assistantResponse.audioResponse.src="",this.assistantResponse.playChime("closing"),this.assistantResponse.end())}},socketNotificationReceived:function(s,t){switch(s){case"LOAD_RECIPE":this.parseLoadedRecipe(t);break;case"NOT_INITIALIZED":this.assistantResponse.fullscreen(!0),this.assistantResponse.showError(this.translate(t.message,{VALUES:t.values})),this.assistantResponse.forceStatusImg("userError");break;case"WARNING":this.sendNotification("EXT_ALERT",{message:this.translate(t),type:"warning",timer:1e4});break;case"INFORMATION":case"ERROR":break;case"INITIALIZED":logGA("Initialized."),this.Version(t),this.assistantResponse.status("standby"),this.doPlugin("onReady"),this.sendNotification("GAv4_READY");break;case"ASSISTANT_RESULT":null!==t.volume&&this.sendNotification("EXT_VOLUME-SET",t.volume),this.assistantResponse.start(t);break;case"TUNNEL":this.assistantResponse.tunnel(t);break;case"ASSISTANT_ACTIVATE":this.assistantActivate(t)}},parseLoadedRecipe:function(payload){let reviver=(key,value)=>{if("string"==typeof value&&0===value.indexOf("__FUNC__")){value=value.slice(8);let functionTemplate=`(${value})`;return eval(functionTemplate)}return value};var p=JSON.parse(payload,reviver);p.hasOwnProperty("commands")&&this.registerCommandsObject(p.commands),p.hasOwnProperty("transcriptionHooks")&&this.registerTranscriptionHooksObject(p.transcriptionHooks),p.hasOwnProperty("responseHooks")&&this.registerResponseHooksObject(p.responseHooks),p.hasOwnProperty("plugins")&&this.registerPluginsObject(p.plugins)},clearAliveTimers(){clearTimeout(this.assistantResponse.aliveTimer),this.assistantResponse.aliveTimer=null,clearTimeout(this.aliveTimer),this.aliveTimer=null},assistantActivate:function(s){if("standby"!=this.GAStatus.actual&&!s.force)return logGA("Assistant is busy.");this.clearAliveTimers(),"continue"==this.GAStatus.actual?this.assistantResponse.showTranscription(this.translate("GAContinue")):this.assistantResponse.showTranscription(this.translate("GABegin")),this.doPlugin("onActivate"),this.assistantResponse.fullscreen(!0),this.lastQuery=null;var t={type:"TEXT",key:null,lang:this.config.assistantConfig.lang,status:this.GAStatus.old,chime:!0};t=Object.assign({},t,s);this.assistantResponse.status(t.type,!!t.chime),this.sendSocketNotification("ACTIVATE_ASSISTANT",t)},endResponse:function(){logGA("Conversation End")},postProcess:function(s,t=(()=>{}),e=(()=>{})){if("continue"==s.lastQuery.status)return e();var n=this.findAllHooks(s);if(n.length>0){this.assistantResponse.status("hook");for(var i=0;i<n.length;i++){var o=n[i];this.doCommand(o.command,o.params,o.from)}this.forceResponse?(this.forceResponse=!1,e()):t()}else e()},findAllHooks:function(s){var t=[];return t=(t=t.concat(this.findTranscriptionHook(s))).concat(this.findResponseHook(s)),this.findNativeAction(s),t},findResponseHook:function(s){var t=[];if(s.screen){var e=[];for(var n in e.links=s.screen.links?s.screen.links:[],e.text=s.screen.text?[].push(s.screen.text):[],e.photos=s.screen.photos?s.screen.photos:[],this.responseHooks)if(this.responseHooks.hasOwnProperty(n)){var i=this.responseHooks[n];if(i.where&&i.pattern&&i.command){var o=new RegExp(i.pattern,"ig").exec(e[i.where]);o&&(t.push({from:n,params:o,command:i.command}),logGA("ResponseHook matched:",n))}}}return t},findTranscriptionHook:function(s){var t=[],e=s.transcription?s.transcription.transcription:"";for(var n in this.transcriptionHooks)if(this.transcriptionHooks.hasOwnProperty(n)){var i=this.transcriptionHooks[n];if(i.pattern&&i.command){var o=new RegExp(i.pattern,"ig").exec(e);o&&(t.push({from:n,params:o,command:i.command}),logGA("TranscriptionHook matched:",n))}else logGA(`TranscriptionHook:${n} has invalid format`)}return t},findNativeAction:function(s){var t=s.action?s.action:null;t&&t.inputs&&t.inputs.forEach((s=>{"action.devices.EXECUTE"==s.intent&&s.payload.commands.forEach((s=>{s.execution.forEach((s=>{logGA("Native Action: "+s.command,s.params),"action.devices.commands.SetVolume"==s.command&&(logGA("Volume Control:",s.params.volumeLevel),this.sendNotification("EXT_VOLUME-SET",s.params.volumeLevel))}))}))}))},doCommand:function(s,t,e){if(this.commands.hasOwnProperty(s)){var n=this.commands[s];n.displayResponse&&(this.forceResponse=!0);var i="object"==typeof t?Object.assign({},t):t;if(n.hasOwnProperty("notificationExec")){var o=n.notificationExec;if(o.notification){var a="function"==typeof o.notification?o.notification(i,e):o.notification,r=o.payload?"function"==typeof o.payload?o.payload(i,e):o.payload:null,c="object"==typeof r?Object.assign({},r):r;logGA(`Command ${s} is executed (notificationExec).`),this.sendNotification(a,c)}}if(n.hasOwnProperty("shellExec")){var p=n.shellExec;if(p.exec){var l="function"==typeof p.exec?p.exec(i,e):p.exec,h=p.options?"function"==typeof p.options?p.options(i,e):p.options:null,u="function"==typeof h?h(i,key):h;l&&(logGA(`Command ${s} is executed (shellExec).`),this.sendSocketNotification("SHELLEXEC",{command:l,options:u}))}}if(n.hasOwnProperty("moduleExec")){var f=n.moduleExec,d="function"==typeof f.module?f.module(i,e):f.module,m=Array.isArray(d)?d:new Array(d);"function"==typeof f.exec&&MM.getModules().enumerate((t=>{(0==m.length||m.indexOf(t.name)>=0)&&(logGA(`Command ${s} is executed (moduleExec) for :`,t.name),f.exec(t,i,e))}))}if(n.hasOwnProperty("functionExec")){var g=n.functionExec;if("function"==typeof g.exec){logGA(`Command ${s} is executed (functionExec)`);try{g.exec(i,e)}catch(s){this.sendNotification("EXT_ALERT",{message:"Function not Found!",type:"warning"})}}}if(n.hasOwnProperty("soundExec")){var A=n.soundExec;A.chime&&"string"==typeof A.chime&&("open"==A.chime&&this.assistantResponse.playChime("open"),"close"==A.chime&&this.assistantResponse.playChime("close"),"opening"==A.chime&&this.assistantResponse.playChime("opening"),"closing"==A.chime&&this.assistantResponse.playChime("closing")),A.sound&&"string"==typeof A.sound&&this.assistantResponse.playChime(A.sound,!0)}}else logGA(`Command ${s} is not found.`)},getCommands:function(s){s.add({command:"query",description:this.translate("QUERY_HELP"),callback:"tbQuery"}),s.add({command:"stop",description:this.translate("STOP_HELP"),callback:"tbStopEXT"})},tbQuery:function(s,t){var e=t.args;e?this.assistantActivate({type:"TEXT",key:e}):t.reply("TEXT",this.translate("QUERY_HELP"))},tbStopEXT:function(s,t){this.stopCommand(),t.reply("TEXT",this.translate("STOP_EXT"))},Loading:function(){this.assistantResponse.forceStatusImg("standby"),this.assistantResponse.showTranscription(this.translate("GALoading")+" MMM-GoogleAssistant"),this.assistantResponse.fullscreen(!0,null,!1)},Version:function(s){this.assistantResponse.showTranscription("MMM-GoogleAssistant v"+s.version+" ("+s.rev+") ©bugsounet "+this.translate("GAReady")),this.assistantResponse.fullscreen(!0,null,!1),this.aliveTimer=setTimeout((()=>{this.assistantResponse.end(!1),this.assistantResponse.showTranscription("")}),this.config.responseConfig.screenOutputTimer)},stopCommand:function(){this.sendNotification("EXT_STOP")},SendToGateway:function(s){if(s.screen&&(s.screen.links.length>0||s.screen.photos.length>0)){let t={photos:s.screen.photos,urls:s.screen.links};logGA("Send response to Gateway:",t),this.sendNotification("EXT_GATEWAY",t)}}});